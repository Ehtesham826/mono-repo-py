version: 2.1
orbs:
  gcp-gke: circleci/gcp-gke@0.1.0
  gcr: circleci/gcp-gcr@0.0.2

jobs:
  build:
    docker:
    - image: google/cloud-sdk
    steps:
    - checkout
    - setup_remote_docker
    - run:
        name: Setup Google Cloud SDK
        command: |
          apt-get install -qq -y gettext
          echo $GCLOUD_SERVICE_KEY > gcloud-service-key.json
          gcloud auth activate-service-account --key-file=gcloud-service-key.json
          ls -l
    - run: 
        name: docker gcloud init
        command: | 
          gcloud auth configure-docker  us-central1-docker.pkg.dev
    - run:
        name: Build and Push Auth Service
        command: |
            docker build -t us-central1-docker.pkg.dev/codetokloud/auth/auth:latest ./services/auth
            docker push us-central1-docker.pkg.dev/codetokloud/auth/auth:latest
    - run:
        name: Build and Push Search Service
        command: |
          docker build -t us-central1-docker.pkg.dev/codetokloud/search/search:latest ./services/search
          docker push us-central1-docker.pkg.dev/codetokloud/search/search:latest
    - run:
        name: Build and Push Payment Service
        command: |
          docker build -t us-central1-docker.pkg.dev/codetokloud/payment/payment:latest ./services/payment
          docker push us-central1-docker.pkg.dev/codetokloud/payment/payment:latest
  deploy:
    docker:
      - image: google/cloud-sdk:latest  # Cloud SDK with Kubernetes and Helm installed
    steps:
      - checkout

      # Authenticate with GKE
      - run:
          name: Authenticate with GKE
          command: |
            echo $GCLOUD_SERVICE_KEY > gcloud-service-key.json
            gcloud auth activate-service-account --key-file=gcloud-service-key.json
            gcloud config set project codetokloud
            gcloud container clusters get-credentials cluster-1 --zone us-central1
      # Install Helm
      - run:
          name: Install Helm
          command: |
            curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash




workflows:
  version: 2
  build_and_deploy:
    jobs:
    - build
