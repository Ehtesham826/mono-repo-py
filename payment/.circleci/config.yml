version: 2.1

jobs:
  detect_payment_changes:
    docker:
    - image: python:3.9-slim
    steps:
    - checkout
    - run:
        name: Check for Changes in Auth Service
        command: |
          if git diff --name-only origin/main...HEAD | grep -q '^payment/'; then
            echo "Changes detected in auth service."
            echo "true" > /tmp/changes_detected.txt
          else
            echo "No changes in auth service."
            echo "false" > /tmp/changes_detected.txt
            exit 0
          fi
    - persist_to_workspace:
        root: /tmp
        paths:
        - changes_detected.txt
    hold_build:
      type: approval
      steps:
      - attach_workspace:
          at: /tmp
      - run:
          name: Check if Build Should Be Held
          command: |
            if [ "$(cat /tmp/changes_detected.txt)" = "true" ]; then
              echo "Changes detected. Skipping hold."
              exit 0  # Skip hold and continue with build.
            else
              echo "No changes detected. Holding build."
              exit 1  # Trigger hold in CircleCI.
            fi

  payment_build:
    docker:
    - image: google/cloud-sdk
    steps:
    - checkout
    - setup_remote_docker

    - run:
        name: Setup Google Cloud SDK
        command: |
          apt-get install -qq -y gettext
          echo $GCLOUD_SERVICE_KEY > gcloud-service-key.json
          gcloud auth activate-service-account --key-file=gcloud-service-key.json
          ls -l
    - run:
        name: docker gcloud init
        command: |
          gcloud auth configure-docker  us-central1-docker.pkg.dev

    - run:
        name: Build and Push Payment Service
        command: |
          docker build -t us-central1-docker.pkg.dev/codetokloud/payment/payment:latest ./services/payment
          docker push us-central1-docker.pkg.dev/codetokloud/payment/payment:latest
  payment_deploy:
    docker:
    - image: google/cloud-sdk:latest
    steps:
    - checkout
    - run:
        name: Authenticate with GKE
        command: |
          echo $GCLOUD_SERVICE_KEY > gcloud-service-key.json
          gcloud auth activate-service-account --key-file=gcloud-service-key.json
          gcloud config set project codetokloud
          gcloud container clusters get-credentials cluster-1 --zone us-central1
    - run:
        name: Install Helm
        command: |
          curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

    - run:
        name: Deploy Payment Service
        command: |
          helm upgrade --install payment ./helm/payment --set image.repository=us-central1-docker.pkg.dev/codetokloud/payment/payment:latest --set image.tag=latest




workflows:
  version: 2
  payment_build_and_deploy:
    jobs:
    - detect_payment_changes
    - hold_build:
        requires:
        - detect_payment_changes
    - payment_build:
        requires:
        - hold_build
    - payment_deploy:
        requires:
        - payment_build
        filters:
          branches:
            only: main
